# Register Functions

To process and analyze data, you need functions that convert an object into another.
This section tells you how to register such functions so that you can run them on the
GUI.

## Function Definition

Basically, a function that processes data is a function that takes a `WidgetDataModel`
object and returns another `WidgetDataModel` object. For example, the following function
formats a non-indented json text data into an indented, pretty json text data.

``` python
from himena import WidgetDataModel

def format_json(model: WidgetDataModel) -> WidgetDataModel:
    value = json.dumps(json.loads(model.value), indent=4)
    return WidgetDataModel(value=value, type="text")
```

Because `himena` has its default widget for `"text"`-type model, this function can be
readly used in the GUI. You can register this function using `register_function()`
function.

``` python hl_lines="4"
from himena import WidgetDataModel
from himena.plugins import register_function
import json

@register_function(title="Format JSON Text")
def format_json(model: WidgetDataModel) -> WidgetDataModel:
    value = json.dumps(json.loads(model.value), indent=4)
    return WidgetDataModel(value=value, type="text")
```

The registered function will be shown in the menu bar (under the "Plugins" menu by
default) and the command palette. When this function is called from the GUI, currently
active window will be converted into a `WidgetDataModel` object and passed to the
function. The returned `WidgetDataModel` object will then be converted into another
window.

## Dependency Injection and Type Narrowing

`himena` uses [`in_n_out`](https://github.com/pyapp-kit/in-n-out) library to inject
the application context into functions. For example, in the previous example, the
`WidgetDataModel` of the current window is injected to the `model` argument of the
`format_json` function. If no window is activated, the "Format JSON Text" menu is grayed
out.

A problem of the example above is that the `model` argument may contain any type of
data (not only `"text"`-type data). To narrow the type of data, you can use the `types`
argument of the `register_function()` decorator.

``` python hl_lines="5"
from himena.consts import StandardType

@register_function(
    title="Format JSON Text",
    types=[StandardType.TEXT],
)
def format_json(model: WidgetDataModel) -> WidgetDataModel:
    ...
```

With this, the "Format JSON Text" menu will be enabled only if the current window is a
widget for `"text"`-type data. Another benefit is that this command will be added to the
[model menu](../tutorial.md#model-menu-button) of the `"text"`-type widget.

## Parametric Functions

Many functions require parameter inputs. It is very easy to implement a parametric
function in Python: just add more arguments to the function. However, implementing
parametric functions in GUI is usually tedious, as you need to create a specific
widget for every function.

`himena` uses [`magicgui`](https://github.com/pyapp-kit/magicgui) package to convert a
function with parameters into a GUI widget based on the type hint of the function.
Therefore, **you can easily register a parametric function just by returning a function**
that takes parameters. To tell `himena` that the returned value should be converted into
a GUI for user input of parameters, you need to **annotate the returned value with the
`Parametric` type**.

``` python hl_lines="2"
from himena.plugins import register_function
from himena.types import Parametric

@register_function(
    title="Format JSON Text",
    types=[StandardType.TEXT],
)
def format_json(model: WidgetDataModel) -> Parametric:
    def run_format_json(indent: int = 4):
        value = json.dumps(json.loads(model.value), indent=indent)
        return WidgetDataModel(value=value, type="text")
    return run_format_json
```

## Configure Parameter Input Window

The parameter input window is automatically generated by `magicgui`. However, you can
further customize its apparence by [`configure_gui()`][himena.plugin.configure_gui]
decorator.

``` python hl_lines="1,9"
from himena.plugins import register_function, configure_gui
from himena.types import Parametric

@register_function(
    title="Format JSON Text",
    types=[StandardType.TEXT],
)
def format_json(model: WidgetDataModel) -> Parametric:
    @configure_gui(
        indent={"label": "Indent in Spaces", "min": 0, "max": 8},
    )
    def run_format_json(indent: int = 4):
        value = json.dumps(json.loads(model.value), indent=indent)
        return WidgetDataModel(value=value, type="text")
    return run_format_json
```

`configure_gui` can take keyword arguments that are passed to the function it decorates,
and use `dict` to configure the widget used for the parameter input.

Here's some of the options you can use.

- `label`: The label of the input field.
- `value`: The default value.
- `choices`: List of choices.
- `widget_type`: Widget class to use. This option must be a [`magicgui` ValueWidget](https://pyapp-kit.github.io/magicgui/widgets/).
- `min`: The minimum value (if applicable).
- `max`: The maximum value (if applicable).

## Preview Function Outputs

In some cases, parameters should be tuned based on the output of the function. For
example in the case of the `format_json` function, the user may want to see the output
so that the json string looks good. To add a "preview" toggle button to the parameter
input window, just add the `preview` argument to the `configure_gui()` decorator.

``` python hl_lines="7"
@register_function(
    title="Format JSON Text",
    types=[StandardType.TEXT],
)
def format_json(model: WidgetDataModel) -> Parametric:
    @configure_gui(
        preview=True,
    )
    def run_format_json(indent: int = 4):
        value = json.dumps(json.loads(model.value), indent=indent)
        return WidgetDataModel(value=value, type="text")
    return run_format_json
```

##
